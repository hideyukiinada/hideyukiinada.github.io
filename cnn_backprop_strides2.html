<html>
<head>
<script type="text/javascript">
		MathJax.Hub.Config({
			TeX: { equationNumbers: { autoNumber: "AMS" } }
		});
</script>
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
</head>
<body>
<h1>CNN backprop with padding and strides=2</h1>

Calculate the following

\begin{equation}
\frac{\partial L}{\partial a_{prev}} = 
\begin{bmatrix}
		\frac{\partial L}{\partial a_{11}} & \frac{\partial L}{\partial a_{12}} & \frac{\partial L}{\partial a_{13}} & \frac{\partial L}{\partial a_{14}} \\
		\frac{\partial L}{\partial a_{21}} & \frac{\partial L}{\partial a_{22}} & \frac{\partial L}{\partial a_{23}} & \frac{\partial L}{\partial a_{24}} \\
		\frac{\partial L}{\partial a_{31}} & \frac{\partial L}{\partial a_{32}} & \frac{\partial L}{\partial a_{33}} & \frac{\partial L}{\partial a_{34}} \\
		\frac{\partial L}{\partial a_{41}} & \frac{\partial L}{\partial a_{42}} & \frac{\partial L}{\partial a_{43}} & \frac{\partial L}{\partial a_{44}}
\end{bmatrix}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial W} = 
\begin{bmatrix}
\frac{\partial L}{\partial w_{11}} & \frac{\partial L}{\partial w_{12}} & \frac{\partial L}{\partial w_{13}}  \\
\frac{\partial L}{\partial w_{21}} & \frac{\partial L}{\partial w_{22}} & \frac{\partial L}{\partial w_{23}}  \\
\frac{\partial L}{\partial w_{31}} & \frac{\partial L}{\partial w_{32}} & \frac{\partial L}{\partial w_{33}} 
\end{bmatrix}
\end{equation}

When below variables are known:
\begin{equation}
\frac{\partial L}{\partial Z} = 
\begin{bmatrix}
\frac{\partial L}{\partial z_{11}} & \frac{\partial L}{\partial z_{12}}  \\
\frac{\partial L}{\partial z_{21}} & \frac{\partial L}{\partial z_{22}}  \\
\end{bmatrix}
\end{equation}

\begin{equation}
a_{prev} = 
\begin{bmatrix}
		a_{11} & a_{12} & a_{13} & a_{14} \\
		a_{21} & a_{22} & a_{23} & a_{24} \\
		a_{31} & a_{32} & a_{33} & a_{34} \\
		a_{41} & a_{42} & a_{43} & a_{44}
\end{bmatrix}
\end{equation}

where zeropadded \( a_{prev} \) is defined as:
\begin{equation}
a_{prev padded}  = 
\begin{bmatrix}
		0 & 0 & 0 & 0 & 0 & 0 \\
		0 & a_{11} & a_{12} & a_{13} & a_{14} & 0 \\
		0 & a_{21} & a_{22} & a_{23} & a_{24} & 0 \\
		0 & a_{31} & a_{32} & a_{33} & a_{34} & 0 \\
		0 & a_{41} & a_{42} & a_{43} & a_{44} & 0 \\
		0 & 0 & 0 & 0 & 0 & 0 
\end{bmatrix}
\end{equation}

\begin{equation}
W = 
\begin{bmatrix}
		w_{11} & w_{12} & w_{13}  \\
		w_{21} & w_{22} & w_{23}  \\
		w_{31} & w_{32} & w_{33} 
\end{bmatrix}
\end{equation}

\begin{equation}
Z = 
\begin{bmatrix}
		z_{11} & z_{12} \\
		z_{21} & z_{22} 
\end{bmatrix}
\end{equation}

\begin{equation}
Z_{11} =  
0 \cdot w_{11} + 0 \cdot      w_{12} + 0 \cdot      w_{13} +
0 \cdot w_{21} + a_{11} \cdot w_{22} + a_{12} \cdot w_{23} +
0 \cdot w_{31} + a_{21} \cdot w_{32} + a_{22} \cdot w_{33}  
\end{equation}

\begin{equation}
Z_{12} =  
0 \cdot      w_{11} + 0 \cdot      w_{12} + 0 \cdot      w_{13} +
a_{12} \cdot w_{21} + a_{13} \cdot w_{22} + a_{14} \cdot w_{23} +
a_{22} \cdot w_{31} + a_{23} \cdot w_{32} + a_{24} \cdot w_{33}  
\end{equation}

\begin{equation}
Z_{21} =  
0 \cdot w_{11} + a_{21} \cdot w_{12} + a_{22} \cdot w_{13} +
0 \cdot w_{21} + a_{31} \cdot w_{22} + a_{32} \cdot w_{23} +
0 \cdot w_{31} + a_{41} \cdot w_{32} + a_{42} \cdot w_{33}  
\end{equation}

\begin{equation}
Z_{22} =  
a_{22} \cdot w_{11} + a_{23} \cdot w_{12} + a_{24} \cdot w_{13} +
a_{32} \cdot w_{21} + a_{33} \cdot w_{22} + a_{34} \cdot w_{23} +
a_{42} \cdot w_{31} + a_{43} \cdot w_{32} + a_{44} \cdot w_{33}  
\end{equation}

Note that last row and column (all zeros) are not used in convolution.

<h2>Solution</h2>
<h3>\( \frac{\partial L}{\partial a_{11}} \)</h3>
\begin{equation}
\frac{\partial L}{\partial a_{11}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{11}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{11}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{11}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{11}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot w_{22} +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot 0
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{11}} = 
\frac{\partial L}{\partial z_{11}} \cdot w_{22}
\end{equation}

<h3>\( \frac{\partial L}{\partial a_{12}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{12}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{12}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{12}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{12}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{12}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot w_{23} +
\frac{\partial L}{\partial z_{12}} \cdot w_{21} +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot 0
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{12}} = 
\frac{\partial L}{\partial z_{11}} \cdot w_{23} +
\frac{\partial L}{\partial z_{12}} \cdot w_{21}
\end{equation}

<h3>\( \frac{\partial L}{\partial a_{13}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{13}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{13}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{13}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{13}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{13}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} 0 +
\frac{\partial L}{\partial z_{12}} \cdot w_{22} +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot 0
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{13}} = 
\frac{\partial L}{\partial z_{12}} \cdot w_{22}
\end{equation}

<h3>\( \frac{\partial L}{\partial a_{14}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{14}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{14}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{14}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{14}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{14}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot w_{23} +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot 0
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{14}} = 
\frac{\partial L}{\partial z_{12}} \cdot w_{23}
\end{equation}

<h3>\( \frac{\partial L}{\partial a_{21}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{21}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{21}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{21}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{21}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{21}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot w_{32} +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot w_{12} +
\frac{\partial L}{\partial z_{22}} \cdot 0
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{21}} = 
\frac{\partial L}{\partial z_{11}} \cdot w_{32} +
\frac{\partial L}{\partial z_{21}} \cdot w_{12}
\end{equation}


<h3>\( \frac{\partial L}{\partial a_{22}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{22}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{22}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{22}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{22}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{22}}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{22}} = 
\frac{\partial L}{\partial z_{11}} \cdot w_{33} +
\frac{\partial L}{\partial z_{12}} \cdot w_{31} +
\frac{\partial L}{\partial z_{21}} \cdot w_{13} +
\frac{\partial L}{\partial z_{22}} \cdot w_{11}
\end{equation}

<h3>\( \frac{\partial L}{\partial a_{23}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{23}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{23}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{23}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{23}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{23}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot w_{32} +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot w_{12}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{23}} = 
\frac{\partial L}{\partial z_{12}} \cdot w_{32} +
\frac{\partial L}{\partial z_{22}} \cdot w_{12}
\end{equation}


<h3>\( \frac{\partial L}{\partial a_{24}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{24}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{24}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{24}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{24}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{24}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot w_{33} +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot w_{13}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{24}} = 
\frac{\partial L}{\partial z_{12}} \cdot w_{33} +
\frac{\partial L}{\partial z_{22}} \cdot w_{13}
\end{equation}

<h3>\( \frac{\partial L}{\partial a_{31}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{31}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{31}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{31}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{31}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{31}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot w_{22} +
\frac{\partial L}{\partial z_{22}} 0
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{31}} = 
\frac{\partial L}{\partial z_{21}} \cdot w_{22}
\end{equation}

<h3>\( \frac{\partial L}{\partial a_{32}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{32}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{32}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{32}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{32}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{32}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot w_{23} +
\frac{\partial L}{\partial z_{22}} \cdot w_{21}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{32}} = 
\frac{\partial L}{\partial z_{21}} \cdot w_{23} +
\frac{\partial L}{\partial z_{22}} \cdot w_{21}
\end{equation}

<h3>\( \frac{\partial L}{\partial a_{33}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{33}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{33}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{33}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{33}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{33}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot w_{22}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{33}} = 
\frac{\partial L}{\partial z_{22}} \cdot w_{22}
\end{equation}

<h3>\( \frac{\partial L}{\partial a_{34}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{34}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{34}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{34}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{34}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{34}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot w_{23}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{34}} = 
\frac{\partial L}{\partial z_{22}} \cdot w_{23}
\end{equation}


<h3>\( \frac{\partial L}{\partial a_{41}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{41}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{41}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{41}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{41}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{41}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot w_{32} +
\frac{\partial L}{\partial z_{22}} 0
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{41}} = 
\frac{\partial L}{\partial z_{21}} \cdot w_{32}
\end{equation}

<h3>\( \frac{\partial L}{\partial a_{42}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{42}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{42}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{42}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{42}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{42}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot w_{33} +
\frac{\partial L}{\partial z_{22}} \cdot w_{31}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{42}} = 
\frac{\partial L}{\partial z_{21}} \cdot w_{33} +
\frac{\partial L}{\partial z_{22}} \cdot w_{31}
\end{equation}

<h3>\( \frac{\partial L}{\partial a_{43}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{43}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{43}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{43}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{43}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{43}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot w_{32}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{43}} = 
\frac{\partial L}{\partial z_{22}} \cdot w_{32}
\end{equation}

<h3>\( \frac{\partial L}{\partial a_{44}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial a_{43}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial a_{44}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial a_{44}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial a_{44}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial a_{44}}
\end{equation}

\begin{equation}
= 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot w_{33}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{44}} = 
\frac{\partial L}{\partial z_{22}} \cdot w_{33}
\end{equation}
<hr>
h1>CNN backprop with padding and strides=2</h1>

\begin{equation}
\frac{\partial L}{\partial a_{prev}} = 
\begin{bmatrix}
\frac{\partial L}{\partial z_{11}} \cdot w_{22} &

\frac{\partial L}{\partial z_{11}} \cdot w_{23} +
\frac{\partial L}{\partial z_{12}} \cdot w_{21} &

\frac{\partial L}{\partial z_{12}} \cdot w_{22} &
\frac{\partial L}{\partial z_{12}} \cdot w_{23} \\


\frac{\partial L}{\partial z_{11}} \cdot w_{32} +
\frac{\partial L}{\partial z_{21}} \cdot w_{12} &

\frac{\partial L}{\partial z_{11}} \cdot w_{33} +
\frac{\partial L}{\partial z_{12}} \cdot w_{31} +
\frac{\partial L}{\partial z_{21}} \cdot w_{13} +
\frac{\partial L}{\partial z_{22}} \cdot w_{11} &

\frac{\partial L}{\partial z_{12}} \cdot w_{32} +
\frac{\partial L}{\partial z_{22}} \cdot w_{12} &

\frac{\partial L}{\partial z_{12}} \cdot w_{33} +
\frac{\partial L}{\partial z_{22}} \cdot w_{13} \\

\frac{\partial L}{\partial z_{21}} \cdot w_{22} &

\frac{\partial L}{\partial z_{21}} \cdot w_{23} +
\frac{\partial L}{\partial z_{22}} \cdot w_{21} &

\frac{\partial L}{\partial z_{22}} \cdot w_{22} &

\frac{\partial L}{\partial z_{22}} \cdot w_{23} \\


\frac{\partial L}{\partial z_{21}} \cdot w_{32} &

\frac{\partial L}{\partial z_{21}} \cdot w_{33} +
\frac{\partial L}{\partial z_{22}} \cdot w_{31} &

\frac{\partial L}{\partial z_{22}} \cdot w_{32} &

\frac{\partial L}{\partial z_{22}} \cdot w_{33}
\end{bmatrix}
\end{equation}

<h2>Insert zero rows and columns into Z</h2>

\begin{equation}
Z = 
\begin{bmatrix}
		z_{11} & z_{12} \\
		z_{21} & z_{22} 
\end{bmatrix}
\end{equation}


\begin{equation}
Z_{2} = 
\begin{bmatrix}
		z_{11} & 0 & z_{12} & 0 \\
		0 & 0 & 0 & 0 \\
		z_{21} & 0 & z_{22} & 0 \\
		0 & 0 & 0 & 0
\end{bmatrix}
\end{equation}

<h2>Zeropad Z</h2>
\begin{equation}
Z_{3} = 
\begin{bmatrix}
		0 & 0 & 0 & 0 & 0 & 0 \\
		0 & z_{11} & 0 & z_{12} & 0 & 0 \\
		0 & 0 & 0 & 0 & 0 & 0 \\
		0 & z_{21} & 0 & z_{22} & 0 & 0 \\
		0 & 0 & 0 & 0 & 0 & 0 \\
		0 & 0 & 0 & 0 & 0 & 0 \\
\end{bmatrix}
\end{equation}

Flip W vertically and horizontally.
\begin{equation}
W_{2} = 
\begin{bmatrix}
		w_{33} & w_{32} & w_{31}  \\
		w_{23} & w_{22} & w_{21}  \\
		w_{13} & w_{12} & w_{11} 
\end{bmatrix}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial a_{prev}} = Z_{3} * W_{2}
\end{equation}

<hr>
<h3>\( \frac{\partial L}{\partial w_{11}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial w_{11}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial w_{11}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial w_{11}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial w_{11}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial w_{11}}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{11}} = 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot a_{22}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{11}} = 
\frac{\partial L}{\partial z_{22}} \cdot a_{22}
\end{equation}

<h3>\( \frac{\partial L}{\partial w_{12}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial w_{12}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial w_{12}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial w_{12}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial w_{12}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial w_{12}}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{12}} = 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot a_{21} +
\frac{\partial L}{\partial z_{22}} \cdot a_{23}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{12}} = 
\frac{\partial L}{\partial z_{21}} \cdot a_{21} +
\frac{\partial L}{\partial z_{22}} \cdot a_{23}
\end{equation}

<h3>\( \frac{\partial L}{\partial w_{13}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial w_{13}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial w_{13}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial w_{13}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial w_{13}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial w_{13}}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{13}} = 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot 0 +
\frac{\partial L}{\partial z_{21}} \cdot a_{22} +
\frac{\partial L}{\partial z_{22}} \cdot a_{24}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{13}} = 
\frac{\partial L}{\partial z_{21}} \cdot a_{22} +
\frac{\partial L}{\partial z_{22}} \cdot a_{24}
\end{equation}

<h3>\( \frac{\partial L}{\partial w_{21}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial w_{21}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial w_{21}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial w_{21}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial w_{21}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial w_{21}}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{21}} = 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot a_{12} +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot a_{32}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{21}} = 
\frac{\partial L}{\partial z_{12}} \cdot a_{12} +
\frac{\partial L}{\partial z_{22}} \cdot a_{32}
\end{equation}

<h3>\( \frac{\partial L}{\partial w_{22}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial w_{22}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial w_{22}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial w_{22}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial w_{22}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial w_{22}}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{22}} = 
\frac{\partial L}{\partial z_{11}} \cdot a_{11} +
\frac{\partial L}{\partial z_{12}} \cdot a_{13} +
\frac{\partial L}{\partial z_{21}} \cdot a_{31} +
\frac{\partial L}{\partial z_{22}} \cdot a_{33}
\end{equation}

<h3>\( \frac{\partial L}{\partial w_{23}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial w_{23}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial w_{23}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial w_{23}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial w_{23}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial w_{23}}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{23}} = 
\frac{\partial L}{\partial z_{11}} \cdot a_{12} +
\frac{\partial L}{\partial z_{12}} \cdot a_{14} +
\frac{\partial L}{\partial z_{21}} \cdot a_{32} +
\frac{\partial L}{\partial z_{22}} \cdot a_{34}
\end{equation}

<h3>\( \frac{\partial L}{\partial w_{31}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial w_{21}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial w_{31}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial w_{31}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial w_{31}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial w_{31}}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{31}} = 
\frac{\partial L}{\partial z_{11}} \cdot 0 +
\frac{\partial L}{\partial z_{12}} \cdot a_{22} +
\frac{\partial L}{\partial z_{21}} \cdot 0 +
\frac{\partial L}{\partial z_{22}} \cdot a_{42}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{31}} = 
\frac{\partial L}{\partial z_{12}} \cdot a_{22} +
\frac{\partial L}{\partial z_{22}} \cdot a_{42}
\end{equation}

<h3>\( \frac{\partial L}{\partial w_{32}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial w_{32}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial w_{32}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial w_{32}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial w_{32}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial w_{32}}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{32}} = 
\frac{\partial L}{\partial z_{11}} \cdot a_{21} +
\frac{\partial L}{\partial z_{12}} \cdot a_{23} +
\frac{\partial L}{\partial z_{21}} \cdot a_{41} +
\frac{\partial L}{\partial z_{22}} \cdot a_{43}
\end{equation}

<h3>\( \frac{\partial L}{\partial w_{33}} \)</h3>

\begin{equation}
\frac{\partial L}{\partial w_{23}} = 
\frac{\partial L}{\partial z_{11}} \cdot \frac{\partial z_{11}}{\partial w_{33}} +
\frac{\partial L}{\partial z_{12}} \cdot \frac{\partial z_{12}}{\partial w_{33}} +
\frac{\partial L}{\partial z_{21}} \cdot \frac{\partial z_{21}}{\partial w_{33}} +
\frac{\partial L}{\partial z_{22}} \cdot \frac{\partial z_{22}}{\partial w_{33}}
\end{equation}

\begin{equation}
\frac{\partial L}{\partial w_{33}} = 
\frac{\partial L}{\partial z_{11}} \cdot a_{22} +
\frac{\partial L}{\partial z_{12}} \cdot a_{24} +
\frac{\partial L}{\partial z_{21}} \cdot a_{42} +
\frac{\partial L}{\partial z_{22}} \cdot a_{44}
\end{equation}

<hr>

\begin{equation}
W_= 
\begin{bmatrix}
\frac{\partial L}{\partial z_{22}} \cdot a_{22} &

\frac{\partial L}{\partial z_{21}} \cdot a_{21} +
\frac{\partial L}{\partial z_{22}} \cdot a_{23} &

\frac{\partial L}{\partial z_{21}} \cdot a_{22} +
\frac{\partial L}{\partial z_{22}} \cdot a_{24} \\


\frac{\partial L}{\partial z_{12}} \cdot a_{12} +
\frac{\partial L}{\partial z_{22}} \cdot a_{32} & 

\frac{\partial L}{\partial z_{11}} \cdot a_{11} +
\frac{\partial L}{\partial z_{12}} \cdot a_{13} +
\frac{\partial L}{\partial z_{21}} \cdot a_{31} +
\frac{\partial L}{\partial z_{22}} \cdot a_{33} &

\frac{\partial L}{\partial z_{11}} \cdot a_{12} +
\frac{\partial L}{\partial z_{12}} \cdot a_{14} +
\frac{\partial L}{\partial z_{21}} \cdot a_{32} +
\frac{\partial L}{\partial z_{22}} \cdot a_{34} \\

\frac{\partial L}{\partial z_{12}} \cdot a_{22} +
\frac{\partial L}{\partial z_{22}} \cdot a_{42} &

\frac{\partial L}{\partial z_{11}} \cdot a_{21} +
\frac{\partial L}{\partial z_{12}} \cdot a_{23} +
\frac{\partial L}{\partial z_{21}} \cdot a_{41} +
\frac{\partial L}{\partial z_{22}} \cdot a_{43} &

\frac{\partial L}{\partial z_{11}} \cdot a_{22} +
\frac{\partial L}{\partial z_{12}} \cdot a_{24} +
\frac{\partial L}{\partial z_{21}} \cdot a_{42} +
\frac{\partial L}{\partial z_{22}} \cdot a_{44}

\end{bmatrix}
\end{equation}
<hr>
This means:

\begin{equation}
a_{prev padded}  = 
\begin{bmatrix}
		0 & 0 & 0 & 0 & 0 & 0 \\
		0 & a_{11} & a_{12} & a_{13} & a_{14} & 0 \\
		0 & a_{21} & a_{22} & a_{23} & a_{24} & 0 \\
		0 & a_{31} & a_{32} & a_{33} & a_{34} & 0 \\
		0 & a_{41} & a_{42} & a_{43} & a_{44} & 0 \\
		0 & 0 & 0 & 0 & 0 & 0 
\end{bmatrix}
\end{equation}


<h2>Zeropad Z</h2>
\begin{equation}
\frac{\partial L}{\partial Z_{2}} = 
\begin{bmatrix}

		\frac{\partial L}{\partial z_{11}} & 0 & \frac{\partial L}{\partial z_{12}} & 0 \\
		0 & 0 & 0 & 0 \\
		\frac{\partial L}{\partial z_{21}} & 0 & \frac{\partial L}{\partial z_{22}} & 0 \\
		0 & 0 & 0 & 0 \\
\end{bmatrix}
\end{equation}






\begin{equation}
\frac{\partial L}{\partial W} = zeropad(a_{prev}) * \frac{\partial L}{\partial Z_{2}}
\end{equation}

Note: operator * means convolution operation and does not mean an element-wise multiplication.
The operand on the right side of the operator is the conv kernel.
</body>
</html>
